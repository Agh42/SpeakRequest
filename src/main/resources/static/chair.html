<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SPEEK.NOW - Chair View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="SPEEK.NOW Chair View - Manage speak requests, track speaking time, and conduct realtime polls for your meeting."/>
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="SPEEK.NOW - Join Meeting"/>
  <meta property="og:description" content="Join this meeting on SPEEK.NOW to request speaking time and participate in polls."/>
  <meta property="og:image" content="https://speek.now/docs/images/chair.png"/>
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="SPEEK.NOW - Join Meeting"/>
  <meta name="twitter:description" content="Join this meeting on SPEEK.NOW to request speaking time and participate in polls."/>
  <meta name="twitter:image" content="https://speek.now/docs/images/chair.png"/>
  
  <link rel="stylesheet" href="styles.css"/>
  <script src="stomp.min.js"></script>
  <script src="purify.min.js"></script>
  <script src="metadata-loader.js"></script>
  <script src="share.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <h1><a href="/landing.html" style="text-decoration: none; color: inherit;">SPEEK.NOW</a> - Chair View</h1>
      <div class="room-code-display">
        <span class="muted small">Room Code:</span>
        <span id="roomCodeDisplay" class="room-code">----</span>
      </div>
      <div id="conn" class="pill">Connecting‚Ä¶</div>
      <div id="chairStatus" class="pill ok">Chair: Occupied (You)</div>
    </header>

    <main class="grid">
      <!-- Manage speakers -->
      <section class="card">
        <h2>Manage speakers</h2>
        <div class="row">
          <button id="btnNext" class="accent">üéôÔ∏è Next speaker</button>
          <button id="btnPause" class="ghost">‚è∏ Pause</button>
          <button id="btnStart" class="primary">‚ñ∂ Start</button>
          <button id="btnReset" class="ghost">‚Ü∫ Reset</button>
        </div>
        
        <h3 class="subsection-heading">Request to speak on behalf</h3>
        <div class="row">
          <input id="participantName" placeholder="Participant initials or name" maxlength="30"/>
        </div>
        <div class="row">
          <button id="btnParticipantRequest" class="primary">‚úã Request to Speak</button>
          <button id="btnParticipantWithdraw" class="ghost">Withdraw Request</button>
        </div>
        <div id="participantStatus" class="muted small">Enter participant's names to request/withdraw on their behalf.</div>
      </section>

      <!-- Chair controls -->
      <section class="card">
        <h2>Meeting Controls</h2>
        <div class="row">
          <button id="btnPopout" class="accent">üì∫ Open Popout Window</button>
          <button id="btnDestroyRoom" class="ghost" style="background-color: #dc2626; color: white;">üóëÔ∏è Destroy Room</button>
        </div>
        <div class="muted small">Open popout window to display speaker queue on separate screen / projector.</div>
        <div class="row">
          <label class="muted">Per-speaker limit (sec)</label>
          <input id="limit" type="number" min="10" step="10" value="180" style="width:110px"/>
          <button id="btnSetLimit" class="ghost">Set</button>
        </div>

        <div class="two">
          <div>
            <div class="muted small">Current speaker</div>
            <div id="curName" class="big">--</div>
          </div>
          <div>
            <div class="muted small">Speaker time</div>
            <div id="speakTimer" class="timer ok">00:00</div>
            <div class="muted tiny" id="remaining">(remaining: 00:00)</div>
          </div>
          <div>
            <div class="muted small">Meeting time</div>
            <div id="meetingTimer" class="timer">00:00</div>
          </div>
        </div>

        <div class="muted small">Queue (<span id="qCount">0</span>)</div>
        <ul id="queue" class="list"></ul>
      </section>

      <!-- Room Info -->
      <section class="card">
        <h2>Room Information</h2>
        <div class="room-info">
          <div class="room-code-large">
            <div class="muted small">Share this code with participants to let them join:</div>
            <div id="roomCodeLarge" class="room-code-big">----</div>
          </div>
          <div class="row">
            <button id="btnCopyCode" class="ghost">üìã Copy Code</button>
            <button id="btnShareLink" class="ghost">üîó Copy Participant Link</button>
          </div>
          <div class="row">
            <button id="btnShareParticipantUrl" class="primary" aria-label="Share participation link">üîó Share Participation Link</button>
          </div>
          <div id="copyStatus" class="muted small"></div>
          
          <!-- Room Configuration -->
          <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 16px;">
            <div class="muted small" style="margin-bottom: 12px; font-weight: bold;">Meeting Configuration</div>
            
            <div style="margin-bottom: 10px;">
              <label for="configTopic" class="muted small" style="display: block; margin-bottom: 4px;">Topic</label>
              <input id="configTopic" type="text" placeholder="Enter meeting topic" style="width: 100%; padding: 6px;" maxlength="100"/>
            </div>
            
            <div style="margin-bottom: 10px;">
              <label for="configParticipationFormat" class="muted small" style="display: block; margin-bottom: 4px;">Participation Format</label>
              <select id="configParticipationFormat" style="width: 100%; padding: 6px;">
                <option value="">-- Select Participation Format --</option>
                <option value="OPEN_DISCUSSION">Open Discussion</option>
                <option value="STRUCTURED_GO_AROUNDS">Structured Go-Arounds</option>
                <option value="PRESENTATIONS_AND_REPORTS">Presentations and Reports</option>
                <option value="SMALL_GROUPS">Small Groups</option>
                <option value="LISTING_IDEAS">Listing Ideas</option>
                <option value="JIGSAW">Jigsaw</option>
                <option value="INDIVIDUAL_WRITING">Individual Writing</option>
                <option value="MULTI_TASKING">Multi-Tasking</option>
                <option value="FISHBOWLS">Fishbowls</option>
                <option value="TRADESHOW">Tradeshow</option>
                <option value="SCRAMBLER">Scrambler</option>
                <option value="ROLEPLAYS">Roleplays</option>
              </select>
            </div>
            
            <div style="margin-bottom: 10px;">
              <label for="configMeetingGoal" class="muted small" style="display: block; margin-bottom: 4px;">Meeting Goal</label>
              <select id="configMeetingGoal" style="width: 100%; padding: 6px;">
                <option value="">-- Select Meeting Goal --</option>
                <option value="MAKE_DECISIONS">Make Decisions</option>
                <option value="ADVANCE_THINKING">Advance the Thinking</option>
                <option value="SHARE_INFORMATION">Share Information</option>
                <option value="OBTAIN_INPUT">Obtain Input</option>
                <option value="IMPROVE_COMMUNICATION">Improve Communication</option>
                <option value="BUILD_CAPACITY">Build Capacity</option>
                <option value="BUILD_COMMUNITY">Build Community</option>
              </select>
            </div>
            
            <div style="margin-bottom: 10px;">
              <label for="configDecisionRule" class="muted small" style="display: block; margin-bottom: 4px;">Decision Rule</label>
              <select id="configDecisionRule" style="width: 100%; padding: 6px;">
                <option value="">-- Select Decision Rule --</option>
                <option value="UNANIMITY">Unanimity</option>
                <option value="GRADIENTS_OF_AGREEMENT">Gradients of Agreement</option>
                <option value="DOT_VOTING">Dot Voting</option>
                <option value="SUPERMAJORITY">Supermajority</option>
                <option value="MAJORITY">Majority</option>
                <option value="PLURALITY">Plurality</option>
                <option value="CONSENT">Consent</option>
                <option value="PERSON_IN_CHARGE">Person in Charge</option>
                <option value="COMMISSION">Commission</option>
                <option value="FLIP_A_COIN">Flip a Coin</option>
              </select>
            </div>
            
            <div style="margin-bottom: 10px;">
              <label for="configDeliverable" class="muted small" style="display: block; margin-bottom: 4px;">A.T. Deliverable</label>
              <select id="configDeliverable" style="width: 100%; padding: 6px;">
                <option value="">-- Select Deliverable --</option>
                <option value="DEFINE_PROBLEM">Define a problem</option>
                <option value="CREATE_MILESTONE_MAP">Create a milestone map</option>
                <option value="ANALYZE_PROBLEM">Analyze a problem</option>
                <option value="CREATE_WORK_BREAKDOWN">Create a work breakdown structure</option>
                <option value="IDENTIFY_ROOT_CAUSES">Identify root causes</option>
                <option value="CONDUCT_RESOURCE_ANALYSIS">Conduct a resource analysis</option>
                <option value="IDENTIFY_PATTERNS">Identify underlying patterns</option>
                <option value="CONDUCT_RISK_ASSESSMENT">Conduct a risk assessment</option>
                <option value="SORT_IDEAS_INTO_THEMES">Sort a list of ideas into themes</option>
                <option value="DEFINE_SELECTION_CRITERIA">Define selection criteria</option>
                <option value="REARRANGE_BY_PRIORITY">Rearrange a list of items by priority</option>
                <option value="EVALUATE_OPTIONS">Evaluate options</option>
                <option value="DRAW_FLOWCHART">Draw a flowchart</option>
                <option value="IDENTIFY_SUCCESS_FACTORS">Identify critical success factors</option>
                <option value="IDENTIFY_CORE_VALUES">Identify core values</option>
                <option value="EDIT_STATEMENT">Edit and/or wordsmith a statement</option>
              </select>
            </div>
            
            <!-- Description Display Area -->
            <div id="configDescriptions" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 0.85rem; line-height: 1.5; display: none;">
              <div class="muted small" style="margin-bottom: 8px; font-weight: bold;">Selected Options:</div>
              <div id="configDescriptionText"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Start Poll -->
      <section class="card">
        <h2>Conduct Poll</h2>
        
        <!-- Poll selection screen -->
        <div id="pollSelection" style="display: block;">
          <div class="muted small" style="margin-bottom: 8px;">Select a poll type to start polling:</div>
          <div class="row">
            <button id="btnYesNoPoll" class="accent">üìä Yes/No Poll</button>
            <button id="btnGradientsPoll" class="accent">üìä Gradients of Agreement</button>
          </div>
          <div class="row" style="margin-top: 8px;">
            <button id="btnSingleSelectionPoll" class="accent">üìä Single Selection</button>
            <button id="btnMultipleSelectionPoll" class="accent">üìä Multiple Selection</button>
          </div>
        </div>
        
        <!-- Poll creation screen -->
        <div id="pollCreation" style="display: none;">
          <div class="row">
            <input id="pollQuestion" placeholder="Enter poll question" maxlength="200" style="flex: 1;"/>
          </div>
          <div class="row">
            <button id="btnStartPolling" class="primary">‚ñ∂Ô∏è Start Polling</button>
            <button id="btnCancelPoll" class="ghost">‚úñ Cancel</button>
          </div>
          <div id="pollCreationStatus" class="muted small"></div>
        </div>
        
        <!-- Multiselect poll creation screen -->
        <div id="multiselectPollCreation" style="display: none;">
          <div class="row">
            <input id="multiselectPollQuestion" placeholder="Enter poll question (max 100 chars)" maxlength="100" style="flex: 1;"/>
          </div>
          
          <div style="margin-top: 12px;">
            <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
              <span class="muted small">Poll Options:</span>
              <a id="btnPasteOptions" href="#" class="muted small" style="text-decoration: underline; cursor: pointer;">paste options</a>
            </div>
            <div id="multiselectOptionsContainer"></div>
            <button id="btnAddOption" class="ghost" style="margin-top: 8px; width: 100%;">+ Add Option</button>
          </div>
          
          <!-- Voting configuration for multiple selection -->
          <div id="votingConfiguration" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); display: none;">
            <div class="muted small" style="margin-bottom: 8px;">Voting Configuration:</div>
            <div class="row">
              <label class="muted small" style="flex: 0 0 auto; margin-right: 8px;">Select up to X options:</label>
              <select id="multiselectVotesPerParticipant" style="flex: 1;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>
          
          <div class="row" style="margin-top: 12px;">
            <button id="btnStartMultiselectPolling" class="primary">‚ñ∂Ô∏è Start Poll</button>
            <button id="btnCancelMultiselectPoll" class="ghost">‚úñ Cancel</button>
          </div>
          <div id="multiselectPollCreationStatus" class="muted small"></div>
        </div>
        
        <!-- Active poll screen -->
        <div id="pollActive" style="display: none;">
          <div class="muted small">Poll Question:</div>
          <div id="activePollQuestion" class="big" style="font-size: 1.1rem; margin: 8px 0;"></div>
          <div class="muted small">Votes received: <span id="pollVoteCount" style="font-weight: bold;">0</span></div>
          <div class="row" style="margin-top: 12px;">
            <button id="btnEndPoll" class="accent">üìä End Poll and Show Results</button>
          </div>
        </div>
        
        <!-- Poll results screen -->
        <div id="pollResults" style="display: none;">
          <div class="muted small">Last Poll Results:</div>
          <div id="pollResultsQuestion" style="font-weight: bold; margin: 8px 0;"></div>
          <div id="pollResultsData" style="margin: 8px 0;"></div>
          <div class="row" style="margin-top: 12px;">
            <button id="btnContinueDiscussion" class="primary">üí¨ Continue Discussion</button>
            <button id="btnNewPoll" class="accent">üìä Start New Poll</button>
          </div>
        </div>
        
        <!-- No polls message -->
        <div id="pollNone" style="display: none;">
          <div class="muted small">No polls conducted yet</div>
          <div class="row" style="margin-top: 12px;">
            <button id="btnStartFirstPoll" class="accent">üìä Start Poll</button>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="footer-links">
        <a href="legal.html">Imprint</a>
        <a href="https://github.com/Agh42/SpeakRequest" target="_blank" rel="noopener noreferrer">Source</a>
        <a href="legal.html">Legal / Data Privacy</a>
      </div>
    </footer>
  </div>

  <!-- Paste Options Modal -->
  <div id="pasteOptionsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 style="margin-top: 0;">Paste Options</h3>
      <textarea id="pasteOptionsTextarea" placeholder="enter one option per line" rows="10" style="width: 100%; padding: 10px; font-size: 16px; background: #0b1020; color: var(--text); border: 1px solid var(--border); border-radius: 10px; font-family: inherit; resize: vertical;"></textarea>
      <div class="row" style="margin-top: 12px;">
        <button id="btnCreateOptions" class="primary">Create Options</button>
        <button id="btnCancelPaste" class="ghost">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // FIXME prevent another participant from joining with same name as currently waiting one



    // Extract room code from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');

    if (!roomCode || roomCode.length !== 4) {
      alert('Invalid room code. Redirecting to home page.');
      window.location.href = '/landing.html';
    }

    // Display room code
    document.getElementById('roomCodeDisplay').textContent = roomCode;
    document.getElementById('roomCodeLarge').textContent = roomCode;

    // --- Utilities ---
    const $ = sel => document.querySelector(sel);
    const fmt = ms => {
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    };
    const setTimerClass = (el, warn, danger)=>{
      el.classList.remove('ok','warn','danger');
      if (danger) el.classList.add('danger'); else if (warn) el.classList.add('warn'); else el.classList.add('ok');
    };

    // --- DOM refs ---
    const elConn = $('#conn');
    const elQueue = $('#queue'); const elQCount = $('#qCount');
    const elCurName = $('#curName');
    const elSpeakTimer = $('#speakTimer'); const elRemaining = $('#remaining');
    const elMeeting = $('#meetingTimer'); const elLimit = $('#limit');
    
    // Participant controls
    const elParticipantName = $('#participantName');
    const elParticipantStatus = $('#participantStatus');
    
    // Poll controls
    const elPollSelection = $('#pollSelection');
    const elPollCreation = $('#pollCreation');
    const elPollActive = $('#pollActive');
    const elPollResults = $('#pollResults');
    const elPollNone = $('#pollNone');
    const elPollQuestion = $('#pollQuestion');
    const elActivePollQuestion = $('#activePollQuestion');
    const elPollVoteCount = $('#pollVoteCount');
    const elPollResultsQuestion = $('#pollResultsQuestion');
    const elPollResultsData = $('#pollResultsData');
    const elPollCreationStatus = $('#pollCreationStatus');
    
    // Multiselect poll controls
    const elMultiselectPollCreation = $('#multiselectPollCreation');
    const elMultiselectPollQuestion = $('#multiselectPollQuestion');
    const elMultiselectOptionsContainer = $('#multiselectOptionsContainer');
    const elMultiselectPollCreationStatus = $('#multiselectPollCreationStatus');
    
    // Paste options modal elements
    const elPasteOptionsModal = $('#pasteOptionsModal');
    const elPasteOptionsTextarea = $('#pasteOptionsTextarea');
    const elBtnPasteOptions = $('#btnPasteOptions');
    const elBtnCancelPaste = $('#btnCancelPaste');
    const elBtnCreateOptions = $('#btnCreateOptions');

    // --- State ---
    let client = null;
    let meetingStart = 0;
    let timerInterval = null;
    let currentState = null; // Add this to store the full state
    let selectedPollType = null; // Track which poll type is being created
    let multiselectOptions = []; // Track multiselect poll options
    let isMultipleSelection = false; // Track if this is multiple selection (vs single selection)

    // --- WebSocket ---
    function connect() {
      const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
      const sock = new WebSocket(`${scheme}://${location.host}/ws`);
      client = Stomp.over(sock);
      client.debug = () => {}; // silence debug

      client.connect({}, () => {
        elConn.textContent = 'Connected';
        elConn.classList.remove('warn');
        elConn.classList.add('ok');

        client.subscribe(`/topic/room/${roomCode}/state`, msg => {
          const state = JSON.parse(msg.body);
          updateUI(state);
        });
        
        // Subscribe to room destroyed event
        client.subscribe(`/topic/room/${roomCode}/destroyed`, msg => {
          const data = JSON.parse(msg.body);
          alert(data.message + '\n\nYou will be redirected to the landing page.');
          window.location.href = data.landingUrl;
        });

        // Join to get initial state
        client.send(`/app/room/${roomCode}/join`, {}, JSON.stringify({name:'Chair'}));
      }, () => {
        elConn.textContent = 'Disconnected';
        elConn.classList.remove('ok');
        elConn.classList.add('warn');
        setTimeout(connect, 2000);
      });
    }

    function updateUI(state) {
      meetingStart = state.meetingStartSec;
      currentState = state; // Store the current state
      elLimit.value = state.defaultLimitSec;

      // Queue
      elQCount.textContent = state.queue.length;
      elQueue.innerHTML = '';
      state.queue.forEach((p, i) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="name">${DOMPurify.sanitize(p.name)}</span>`;
        elQueue.appendChild(li);
      });

      // Current speaker
      if (state.current) {
        const c = state.current;
        elCurName.textContent = DOMPurify.sanitize(c.entry.name);
      } else {
        elCurName.textContent = '--';
      }

      updateTimers(state);
      updatePollUI(state);
      updateRoomConfigUI(state);
    }
    
    function updatePollUI(state) {
      // Check if user is currently configuring a poll - if so, don't update the UI
      const isConfiguringPoll = elPollCreation.style.display === 'block' || 
                                elMultiselectPollCreation.style.display === 'block';
      
      if (isConfiguringPoll) {
        // User is in the middle of configuring a poll, don't reset the UI
        return;
      }
      
      // Hide all poll screens first
      elPollSelection.style.display = 'none';
      elPollCreation.style.display = 'none';
      elMultiselectPollCreation.style.display = 'none';
      elPollActive.style.display = 'none';
      elPollResults.style.display = 'none';
      elPollNone.style.display = 'none';
      
      if (!state.pollState) {
        // No poll state - show "no polls conducted yet"
        elPollNone.style.display = 'block';
        return;
      }
      
      const poll = state.pollState;
      
      if (poll.status === 'ACTIVE') {
        // Active poll
        elPollActive.style.display = 'block';
        elActivePollQuestion.textContent = DOMPurify.sanitize(poll.question);
        elPollVoteCount.textContent = poll.totalVotes || 0;
      } else if (poll.status === 'ENDED') {
        // Poll ended - show results
        elPollResults.style.display = 'block';
        elPollResultsQuestion.textContent = DOMPurify.sanitize(poll.question);
        
        // Display results based on poll type
        let resultsHTML = '<div style="margin-top: 8px;">';
        
        if (poll.pollType === 'GRADIENTS') {
          // Display Gradients of Agreement results as horizontal number line
          resultsHTML += renderGradientsResults(poll.results, poll.totalVotes);
        } else if (poll.pollType === 'MULTISELECT' || poll.pollType === 'MULTISELECT_MULTIPLE' || (poll.options && poll.options.length > 0)) {
          // Display Multiselect results as horizontal bar chart
          resultsHTML += renderMultiselectResults(poll.results, poll.totalVotes, poll.options);
        } else {
          // Display Yes/No results as before
          for (const [option, count] of Object.entries(poll.results)) {
            const percentage = poll.totalVotes > 0 ? Math.round((count / poll.totalVotes) * 100) : 0;
            resultsHTML += `<div style="margin: 4px 0;"><strong>${option}:</strong> ${count} (${percentage}%)</div>`;
          }
        }
        
        resultsHTML += `<div style="margin-top: 8px;" class="muted small">Total votes: ${poll.totalVotes}</div>`;
        resultsHTML += '</div>';
        elPollResultsData.innerHTML = resultsHTML;
      } else if (poll.status === 'CLOSED' || poll.lastResults) {
        // Poll closed or showing last results - return to "no polls" view
        elPollNone.style.display = 'block';
      } else {
        // No polls yet - show message
        elPollNone.style.display = 'block';
      }
    }
    
    function renderGradientsResults(results, totalVotes) {
      const gradientOptions = [
        { key: 'OPT_1', num: '1', label: 'Whole-hearted Endorsement' },
        { key: 'OPT_2', num: '2', label: 'Agreement with Minor Point' },
        { key: 'OPT_3', num: '3', label: 'Support with Reservations' },
        { key: 'OPT_4', num: '4', label: 'Abstain' },
        { key: 'OPT_5', num: '5', label: 'More Discussion Needed' },
        { key: 'OPT_6', num: '6', label: 'Don\'t Like But Will Support' },
        { key: 'OPT_7', num: '7', label: 'Serious Disagreement' },
        { key: 'OPT_8', num: '8', label: 'Veto' }
      ];
      
      let html = '<div style="margin: 16px 0; font-size: 0.75rem;">';
      html += '<div style="display: flex; align-items: flex-end; justify-content: space-between; height: 120px; margin-bottom: 8px;">';
      
      // Create bars for each option
      gradientOptions.forEach(opt => {
        const count = results[opt.key] || 0;
        const maxBarHeight = 120; // Match the container height
        const heightPx = totalVotes > 0 ? Math.max((count / totalVotes) * maxBarHeight, count > 0 ? 4 : 0) : 0;
        
        html += `<div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative;">`;
        // Count above bar
        if (count > 0) {
          html += `<div style="font-weight: bold; font-size: 0.7rem; color: rgba(96,165,250,1); margin-bottom: 2px;">${count}</div>`;
        }
        // Bar
        html += `<div style="background: rgba(96,165,250,0.6); width: 80%; height: ${heightPx}px; border-radius: 4px 4px 0 0;"></div>`;
        html += `</div>`;
      });
      
      html += '</div>';
      
      // Number line with wrapped labels
      html += '<div style="display: flex; justify-content: space-between; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 8px;">';
      
      gradientOptions.forEach(opt => {
        html += `<div style="flex: 1; display: flex; flex-direction: column; align-items: center; min-height: 100px; padding: 0 2px;">`;
        html += `<div style="font-weight: bold; font-size: 0.85rem; margin-bottom: 6px;">${opt.num}</div>`;
        // Wrapped label
        html += `<div style="font-size: 0.5rem; text-align: center; line-height: 1.2; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto; max-width: 100%;">${opt.label}</div>`;
        html += `</div>`;
      });
      
      html += '</div>';
      html += '<div style="margin-top: 8px; font-size: 0.45rem; color: rgba(255,255,255,0.5); font-style: italic;">Reference: Kaner, S. (2014). Facilitator\'s Guide to Participatory Decision-Making. Third edition, Jossey-Bass: San Francisco, California, United States of America.</div>';
      html += '</div>';
      
      return html;
    }
    
    function renderMultiselectResults(results, totalVotes, options) {
      let html = '<div style="margin: 16px 0;">';
      
      // Create horizontal bars for each option
      options.forEach((optionLabel, index) => {
        const optionKey = `OPT_${index}`;
        const count = results[optionKey] || 0;
        const percentage = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
        const widthPercent = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        
        html += `<div style="margin: 12px 0;">`;
        // Option label
        html += `<div style="font-weight: bold; margin-bottom: 4px; font-size: 0.95rem;">${DOMPurify.sanitize(optionLabel)}</div>`;
        // Bar container
        html += `<div style="display: flex; align-items: center; gap: 8px;">`;
        // Bar
        html += `<div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; height: 24px; position: relative; overflow: hidden;">`;
        html += `<div style="background: rgba(96,165,250,0.6); width: ${widthPercent}%; height: 100%; border-radius: 4px; transition: width 0.3s ease;"></div>`;
        html += `</div>`;
        // Count and percentage
        html += `<div style="min-width: 80px; text-align: right; font-weight: bold; font-size: 0.9rem;">${count} (${percentage}%)</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      
      html += '</div>';
      
      return html;
    }

    function updateTimers(state) {
      const nowSec = Math.floor(Date.now() / 1000);

      // Meeting timer
      const meetingMs = (nowSec - meetingStart) * 1000;
      elMeeting.textContent = fmt(meetingMs);

      // Speaker timer
      if (state.current) {
        const c = state.current;
        let elapsedMs = c.elapsedMs;
        if (c.running) {
          elapsedMs += (nowSec - c.startedAtSec) * 1000;
        }
        elSpeakTimer.textContent = fmt(elapsedMs);

        const remainingMs = Math.max(0, (c.limitSec * 1000) - elapsedMs);
        elRemaining.textContent = `(remaining: ${fmt(remainingMs)})`;

        const warnThreshold = c.limitSec * 1000 * 0.8;
        const dangerThreshold = c.limitSec * 1000 * 0.95;
        setTimerClass(elSpeakTimer, elapsedMs > warnThreshold, elapsedMs > dangerThreshold);
      } else {
        elSpeakTimer.textContent = '00:00';
        elRemaining.textContent = '(remaining: 00:00)';
        setTimerClass(elSpeakTimer, false, false);
      }
    }

    // --- Event handlers ---
    // Participant controls (on-behalf requests)
    $('#btnParticipantRequest').onclick = () => {
      const name = elParticipantName.value.trim();
      if (!name) {
        elParticipantStatus.textContent = 'Please enter participant name first';
        elParticipantStatus.className = 'warn small';
        return;
      }
      client?.send(`/app/room/${roomCode}/request`, {}, JSON.stringify({name}));
      elParticipantStatus.textContent = `‚úã Request sent for ${name}`;
      elParticipantStatus.className = 'muted small';
    };

    $('#btnParticipantWithdraw').onclick = () => {
      const name = elParticipantName.value.trim();
      if (!name) {
        elParticipantStatus.textContent = 'Please enter participant name first';
        elParticipantStatus.className = 'warn small';
        return;
      }
      client?.send(`/app/room/${roomCode}/withdraw`, {}, JSON.stringify({name}));
      elParticipantStatus.textContent = `Request withdrawn for ${name}`;
      elParticipantStatus.className = 'muted small';
    };

    // Enter key handler for participant name input
    elParticipantName.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const name = elParticipantName.value.trim();
        if (!name) {
          elParticipantStatus.textContent = 'Please enter participant name first';
          elParticipantStatus.className = 'warn small';
          return;
        }
        
        // Check if participant is already in queue, if so withdraw, otherwise request
        const inQueue = currentState && currentState.queue.some(p => p.name.toLowerCase() === name.toLowerCase());
        if (inQueue) {
          $('#btnParticipantWithdraw').click();
        } else {
          $('#btnParticipantRequest').click();
        }
      }
    });

    // Select all text when clicking in the input
    elParticipantName.addEventListener('click', () => {
      elParticipantName.select();
    });

    // Select all text when input gains focus
    elParticipantName.addEventListener('focus', () => {
      elParticipantName.select();
    });

    // Meeting controls
    $('#btnNext').onclick = () => client?.send(`/app/room/${roomCode}/next`, {}, '{}');
    $('#btnPause').onclick = () => client?.send(`/app/room/${roomCode}/timer`, {}, JSON.stringify({action:'pause'}));
    $('#btnStart').onclick = () => client?.send(`/app/room/${roomCode}/timer`, {}, JSON.stringify({action:'start'}));
    $('#btnReset').onclick = () => client?.send(`/app/room/${roomCode}/timer`, {}, JSON.stringify({action:'reset'}));
    $('#btnSetLimit').onclick = () => {
      const sec = parseInt(elLimit.value, 10);
      if (sec >= 10) client?.send(`/app/room/${roomCode}/setLimit`, {}, JSON.stringify({seconds:sec}));
    };

    $('#btnPopout').onclick = () => {
      const url = `/popout.html?room=${roomCode}`;
      window.open(url, 'popout', 'width=325,height=870,resizable=yes');
    };
    
    $('#btnDestroyRoom').onclick = () => {
      const confirmed = confirm(
        '‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\n' +
        'Are you sure you want to destroy this room?\n\n' +
        'This will:\n' +
        '‚Ä¢ End the current discussion\n' +
        '‚Ä¢ Disconnect all participants\n' +
        '‚Ä¢ Close all popout windows\n' +
        '‚Ä¢ Delete the room permanently\n\n' +
        'This action cannot be undone!'
      );
      
      if (confirmed) {
        client?.send(`/app/room/${roomCode}/destroy`, {}, '{}');
      }
    };

    // Copy room code
    $('#btnCopyCode').onclick = async () => {
      try {
        await navigator.clipboard.writeText(roomCode);
        $('#copyStatus').textContent = 'Room code copied to clipboard!';
        setTimeout(() => $('#copyStatus').textContent = '', 3000);
      } catch (err) {
        $('#copyStatus').textContent = 'Could not copy to clipboard';
      }
    };

    // Copy participant link
    $('#btnShareLink').onclick = async () => {
      const link = `${window.location.origin}/room/${roomCode}`;
      try {
        await navigator.clipboard.writeText(link);
        $('#copyStatus').textContent = 'Participant link copied to clipboard!';
        setTimeout(() => $('#copyStatus').textContent = '', 3000);
      } catch (err) {
        $('#copyStatus').textContent = 'Could not copy to clipboard';
      }
    };

    // Poll event handlers
    $('#btnYesNoPoll').onclick = () => {
      selectedPollType = 'YES_NO';
      elPollSelection.style.display = 'none';
      elPollCreation.style.display = 'block';
      elPollQuestion.value = '';
      elPollQuestion.focus();
    };
    
    $('#btnGradientsPoll').onclick = () => {
      selectedPollType = 'GRADIENTS';
      elPollSelection.style.display = 'none';
      elPollCreation.style.display = 'block';
      elPollQuestion.value = '';
      elPollQuestion.focus();
    };
    
    $('#btnCancelPoll').onclick = () => {
      elPollCreation.style.display = 'none';
      elPollSelection.style.display = 'block';
      selectedPollType = null;
    };
    
    $('#btnStartPolling').onclick = () => {
      const question = elPollQuestion.value.trim();
      if (!question) {
        elPollCreationStatus.textContent = 'Please enter a question';
        elPollCreationStatus.className = 'warn small';
        return;
      }
      
      if (!selectedPollType) {
        elPollCreationStatus.textContent = 'Poll type not selected';
        elPollCreationStatus.className = 'warn small';
        return;
      }
      
      client?.send(`/app/room/${roomCode}/poll/start`, {}, JSON.stringify({
        question: question,
        pollType: selectedPollType
      }));
      
      elPollCreationStatus.textContent = 'Poll started!';
      elPollCreationStatus.className = 'muted small';
      selectedPollType = null;
      
      // Hide the poll creation panel so updatePollUI can switch to active poll view
      elPollCreation.style.display = 'none';
    };
    
    $('#btnEndPoll').onclick = () => {
      client?.send(`/app/room/${roomCode}/poll/end`, {}, '{}');
    };
    
    $('#btnContinueDiscussion').onclick = () => {
      // Send close message to move poll to "previous poll" box and return participants to normal view
      client?.send(`/app/room/${roomCode}/poll/close`, {}, '{}');
      // UI will update automatically when state broadcast is received
    };
    
    $('#btnStartFirstPoll').onclick = () => {
      elPollNone.style.display = 'none';
      elPollSelection.style.display = 'block';
    };
    
    $('#btnNewPoll').onclick = () => {
      elPollResults.style.display = 'none';
      elPollNone.style.display = 'none';
      elPollSelection.style.display = 'block';
    };
    
    // Enter key handler for poll question input
    elPollQuestion.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        $('#btnStartPolling').click();
      }
    });
    
    // Single selection poll event handler
    $('#btnSingleSelectionPoll').onclick = () => {
      selectedPollType = 'MULTISELECT';
      isMultipleSelection = false;
      elPollSelection.style.display = 'none';
      elMultiselectPollCreation.style.display = 'block';
      elMultiselectPollQuestion.value = '';
      
      // Hide voting configuration for single selection
      $('#votingConfiguration').style.display = 'none';
      
      // Initialize with 2 default options
      multiselectOptions = ['', ''];
      renderMultiselectOptions();
      
      // Focus on question input
      elMultiselectPollQuestion.focus();
    };
    
    // Multiple selection poll event handler
    $('#btnMultipleSelectionPoll').onclick = () => {
      selectedPollType = 'MULTISELECT_MULTIPLE';
      isMultipleSelection = true;
      elPollSelection.style.display = 'none';
      elMultiselectPollCreation.style.display = 'block';
      elMultiselectPollQuestion.value = '';
      
      // Show voting configuration for multiple selection
      $('#votingConfiguration').style.display = 'block';
      
      // Initialize with 2 default options
      multiselectOptions = ['', ''];
      renderMultiselectOptions();
      
      // Focus on question input
      elMultiselectPollQuestion.focus();
    };
    
    function renderMultiselectOptions() {
      elMultiselectOptionsContainer.innerHTML = '';
      
      multiselectOptions.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'row';
        optionDiv.style.marginBottom = '8px';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `Option ${index + 1}`;
        input.maxLength = 100;
        input.value = option;
        input.style.flex = '1';
        input.addEventListener('input', (e) => {
          multiselectOptions[index] = e.target.value;
          updateVotesPerParticipantDropdown();
        });
        
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '‚úñ Remove';
        removeBtn.className = 'ghost';
        removeBtn.style.marginLeft = '8px';
        removeBtn.disabled = multiselectOptions.length <= 2; // Minimum 2 options
        removeBtn.onclick = () => {
          if (multiselectOptions.length > 2) {
            multiselectOptions.splice(index, 1);
            renderMultiselectOptions();
          }
        };
        
        optionDiv.appendChild(input);
        optionDiv.appendChild(removeBtn);
        elMultiselectOptionsContainer.appendChild(optionDiv);
      });
      
      // Update add button state
      $('#btnAddOption').disabled = multiselectOptions.length >= 100;
      
      // Update votes per participant dropdown
      updateVotesPerParticipantDropdown();
    }
    
    function updateVotesPerParticipantDropdown() {
      if (!isMultipleSelection) return;
      
      const validOptions = multiselectOptions.filter(opt => opt.trim() !== '').length;
      const maxVotes = Math.min(validOptions, 100);
      const dropdown = $('#multiselectVotesPerParticipant');
      
      dropdown.innerHTML = '';
      for (let i = 1; i <= maxVotes; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        // Always select the maximum number of votes by default
        if (i === maxVotes) {
          opt.selected = true;
        }
        dropdown.appendChild(opt);
      }
      
      // Ensure the dropdown value is set to maximum votes
      if (maxVotes > 0) {
        dropdown.value = maxVotes;
      }
    }
    
    $('#btnAddOption').onclick = () => {
      if (multiselectOptions.length < 100) {
        multiselectOptions.push('');
        renderMultiselectOptions();
      }
    };
    
    // Paste options modal handlers
    elBtnPasteOptions.onclick = (e) => {
      e.preventDefault();
      elPasteOptionsModal.style.display = 'flex';
      // Pre-fill with current options, one per line
      elPasteOptionsTextarea.value = multiselectOptions.join('\n');
      elPasteOptionsTextarea.focus();
    };
    
    elBtnCancelPaste.onclick = () => {
      elPasteOptionsModal.style.display = 'none';
    };
    
    elBtnCreateOptions.onclick = () => {
      const text = elPasteOptionsTextarea.value.trim();
      
      if (!text) {
        elPasteOptionsModal.style.display = 'none';
        return;
      }
      
      // Parse options - one per line
      const newOptions = text.split('\n')
        .map(line => line.trim())
        .filter(line => line !== ''); // Remove empty lines
      
      if (newOptions.length === 0) {
        elPasteOptionsModal.style.display = 'none';
        return;
      }
      
      // Replace all existing options with the new list (up to max 100)
      multiselectOptions = newOptions.slice(0, 100);
      renderMultiselectOptions();
      
      // Hide modal
      elPasteOptionsModal.style.display = 'none';
    };
    
    // Close modal when clicking outside of it
    elPasteOptionsModal.onclick = (e) => {
      if (e.target.id === 'pasteOptionsModal') {
        elPasteOptionsModal.style.display = 'none';
      }
    };
    
    $('#btnCancelMultiselectPoll').onclick = () => {
      elMultiselectPollCreation.style.display = 'none';
      elPollSelection.style.display = 'block';
      selectedPollType = null;
      multiselectOptions = [];
      isMultipleSelection = false;
    };
    
    $('#btnStartMultiselectPolling').onclick = () => {
      const question = elMultiselectPollQuestion.value.trim();
      if (!question) {
        elMultiselectPollCreationStatus.textContent = 'Please enter a question';
        elMultiselectPollCreationStatus.className = 'warn small';
        return;
      }
      
      // Filter out empty options and validate minimum 2
      const validOptions = multiselectOptions.filter(opt => opt.trim() !== '');
      if (validOptions.length < 2) {
        elMultiselectPollCreationStatus.textContent = 'Please enter at least 2 options';
        elMultiselectPollCreationStatus.className = 'warn small';
        return;
      }
      
      // Get votes per participant value (for multiple selection)
      let votesPerParticipant = 1;
      if (isMultipleSelection) {
        votesPerParticipant = parseInt($('#multiselectVotesPerParticipant').value, 10);
        
        // Limit to max number of options
        if (votesPerParticipant > validOptions.length) {
          votesPerParticipant = validOptions.length;
        }
      }
      
      client?.send(`/app/room/${roomCode}/poll/start`, {}, JSON.stringify({
        question: question,
        pollType: selectedPollType,
        options: validOptions,
        votesPerParticipant: votesPerParticipant,
        votesPerOption: 1
      }));
      
      elMultiselectPollCreationStatus.textContent = 'Poll started!';
      elMultiselectPollCreationStatus.className = 'muted small';
      selectedPollType = null;
      multiselectOptions = [];
      isMultipleSelection = false;
      
      // Hide the multiselect poll creation panel so updatePollUI can switch to active poll view
      elMultiselectPollCreation.style.display = 'none';
    };
    
    // Enter key handler for multiselect poll question input
    elMultiselectPollQuestion.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        $('#btnStartMultiselectPolling').click();
      }
    });

    // --- Room Configuration ---
    const elConfigTopic = $('#configTopic');
    const elConfigMeetingGoal = $('#configMeetingGoal');
    const elConfigParticipationFormat = $('#configParticipationFormat');
    const elConfigDecisionRule = $('#configDecisionRule');
    const elConfigDeliverable = $('#configDeliverable');
    const elConfigDescriptions = $('#configDescriptions');
    const elConfigDescriptionText = $('#configDescriptionText');
    
    // Descriptions loaded from server
    let descriptions = {
      meetingGoal: {},
      participationFormat: {},
      decisionRule: {},
      deliverable: {}
    };
    
    function updateConditionalFields() {
      const meetingGoal = elConfigMeetingGoal.value;
      
      // Enable/disable Decision Rule based on Meeting Goal
      if (meetingGoal === 'MAKE_DECISIONS') {
        elConfigDecisionRule.disabled = false;
      } else {
        elConfigDecisionRule.disabled = true;
        elConfigDecisionRule.value = '';
      }
      
      // Enable/disable Deliverable based on Meeting Goal
      if (meetingGoal === 'ADVANCE_THINKING') {
        elConfigDeliverable.disabled = false;
      } else {
        elConfigDeliverable.disabled = true;
        elConfigDeliverable.value = '';
      }
    }
    
    function updateDescriptionDisplay() {
      const meetingGoal = elConfigMeetingGoal.value;
      const participationFormat = elConfigParticipationFormat.value;
      const decisionRule = elConfigDecisionRule.value;
      const deliverable = elConfigDeliverable.value;
      
      let html = '';
      let hasAnySelection = false;
      
      if (participationFormat) {
        hasAnySelection = true;
        const optionText = elConfigParticipationFormat.options[elConfigParticipationFormat.selectedIndex].text;
        const desc = descriptions.participationFormat[participationFormat]?.description || 'NOT FOUND';
        html += `<div style="margin-bottom: 8px;"><strong>Participation Format:</strong> ${optionText}<br/><span style="color: rgba(255,255,255,0.7);">${desc}</span></div>`;
      }
      
      if (meetingGoal) {
        hasAnySelection = true;
        const optionText = elConfigMeetingGoal.options[elConfigMeetingGoal.selectedIndex].text;
        const desc = descriptions.meetingGoal[meetingGoal]?.description || 'NOT FOUND';
        html += `<div style="margin-bottom: 8px;"><strong>Meeting Goal:</strong> ${optionText}<br/><span style="color: rgba(255,255,255,0.7);">${desc}</span></div>`;
      }
      
      if (decisionRule) {
        hasAnySelection = true;
        const optionText = elConfigDecisionRule.options[elConfigDecisionRule.selectedIndex].text;
        const desc = descriptions.decisionRule[decisionRule]?.description || 'NOT FOUND';
        html += `<div style="margin-bottom: 8px;"><strong>Decision Rule:</strong> ${optionText}<br/><span style="color: rgba(255,255,255,0.7);">${desc}</span></div>`;
      }
      
      if (deliverable) {
        hasAnySelection = true;
        const optionText = elConfigDeliverable.options[elConfigDeliverable.selectedIndex].text;
        const desc = descriptions.deliverable[deliverable]?.description || 'NOT FOUND';
        html += `<div style="margin-bottom: 8px;"><strong>Advance Thinking: Deliverable:</strong> ${optionText}<br/><span style="color: rgba(255,255,255,0.7);">${desc}</span></div>`;
      }
      
      if (hasAnySelection) {
        elConfigDescriptionText.innerHTML = html;
        elConfigDescriptions.style.display = 'block';
      } else {
        elConfigDescriptions.style.display = 'none';
      }
    }
    
    function saveConfiguration() {
      const config = {
        topic: elConfigTopic.value.trim() || null,
        meetingGoal: elConfigMeetingGoal.value || null,
        participationFormat: elConfigParticipationFormat.value || null,
        decisionRule: elConfigDecisionRule.value || null,
        deliverable: elConfigDeliverable.value || null
      };
      
      client?.send(`/app/room/${roomCode}/updateConfig`, {}, JSON.stringify(config));
    }
    
    // Update descriptions when selections change and auto-save
    elConfigTopic.addEventListener('blur', () => {
      saveConfiguration();
    });
    elConfigMeetingGoal.addEventListener('change', () => {
      updateConditionalFields();
      updateDescriptionDisplay();
      saveConfiguration();
    });
    elConfigParticipationFormat.addEventListener('change', () => {
      updateDescriptionDisplay();
      saveConfiguration();
    });
    elConfigDecisionRule.addEventListener('change', () => {
      updateDescriptionDisplay();
      saveConfiguration();
    });
    elConfigDeliverable.addEventListener('change', () => {
      updateDescriptionDisplay();
      saveConfiguration();
    });
    
    // Update UI with room configuration from state
    function updateRoomConfigUI(state) {
      if (state.roomConfig) {
        const config = state.roomConfig;
        
        // Update form fields
        elConfigTopic.value = config.topic || '';
        elConfigMeetingGoal.value = config.meetingGoal || '';
        elConfigParticipationFormat.value = config.participationFormat || '';
        elConfigDecisionRule.value = config.decisionRule || '';
        elConfigDeliverable.value = config.deliverable || '';
        
        // Update conditional fields
        updateConditionalFields();
        
        // Update descriptions
        updateDescriptionDisplay();
      }
    }

    // --- Start ---
    // Load metadata first, then connect
    MetadataLoader.loadAll().then(metadata => {
      descriptions = metadata;
      connect();
      timerInterval = setInterval(() => {
        if (currentState) {
          updateTimers(currentState);
        }
      }, 250);
    }).catch(err => {
      console.error('Failed to load metadata, continuing anyway:', err);
      // Connect anyway with fallback values
      connect();
      timerInterval = setInterval(() => {
        if (currentState) {
          updateTimers(currentState);
        }
      }, 250);
    });

    // Initialize share button
    const shareParticipantBtn = $('#btnShareParticipantUrl');
    if (shareParticipantBtn) {
      ShareButton.init(shareParticipantBtn, {
        shareUrl: `${window.location.origin}/room/${roomCode}`,
        title: 'Join Meeting on SPEEK.NOW',
        text: `Join the meeting with room code ${roomCode}:`
      });
    }
  </script>
</body>
</html>
