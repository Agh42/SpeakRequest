<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SPEEK.NOW - Chair View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="styles.css"/>
  <script src="stomp.min.js"></script>
  <script src="purify.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <h1><a href="/landing.html" style="text-decoration: none; color: inherit;">SPEEK.NOW</a> - Chair View</h1>
      <div class="room-code-display">
        <span class="muted small">Room Code:</span>
        <span id="roomCodeDisplay" class="room-code">----</span>
      </div>
      <div id="conn" class="pill">Connecting‚Ä¶</div>
      <div id="chairStatus" class="pill ok">Chair: Occupied (You)</div>
    </header>

    <main class="grid">
      <!-- Participant Controls (for on-behalf requests) -->
      <section class="card">
        <h2>Request to Speak (On Behalf)</h2>
        <div class="row">
          <input id="participantName" placeholder="Participant initials or name" maxlength="30"/>
        </div>
        <div class="row">
          <button id="btnParticipantRequest" class="primary">‚úã Request to Speak</button>
          <button id="btnParticipantWithdraw" class="ghost">Withdraw Request</button>
        </div>
        <div id="participantStatus" class="muted small">Enter participant's names to request/withdraw on their behalf.</div>
        <div class="muted small">Open popout window to display speaker queue on separate screen / projector.</div>
      </section>

      <!-- Chair controls -->
      <section class="card">
        <h2>Meeting Controls</h2>
        <div class="row">
          <button id="btnNext" class="accent">üéôÔ∏è Next speaker</button>
          <button id="btnPause" class="ghost">‚è∏ Pause</button>
          <button id="btnStart" class="primary">‚ñ∂ Start</button>
          <button id="btnReset" class="ghost">‚Ü∫ Reset</button>
        </div>
        <div class="row">
          <button id="btnPopout" class="accent">üì∫ Open Popout Window</button>
        </div>
        <div class="row">
          <label class="muted">Per-speaker limit (sec)</label>
          <input id="limit" type="number" min="10" step="10" value="180" style="width:110px"/>
          <button id="btnSetLimit" class="ghost">Set</button>
        </div>

        <div class="two">
          <div>
            <div class="muted small">Current speaker</div>
            <div id="curName" class="big">--</div>
          </div>
          <div>
            <div class="muted small">Speaker time</div>
            <div id="speakTimer" class="timer ok">00:00</div>
            <div class="muted tiny" id="remaining">(remaining: 00:00)</div>
          </div>
          <div>
            <div class="muted small">Meeting time</div>
            <div id="meetingTimer" class="timer">00:00</div>
          </div>
        </div>

        <div class="muted small">Queue (<span id="qCount">0</span>)</div>
        <ul id="queue" class="list"></ul>
      </section>

      <!-- Room Info -->
      <section class="card">
        <h2>Room Information</h2>
        <div class="room-info">
          <div class="room-code-large">
            <div class="muted small">Share this code with participants to let them join:</div>
            <div id="roomCodeLarge" class="room-code-big">----</div>
          </div>
          <div class="row">
            <button id="btnCopyCode" class="ghost">üìã Copy Code</button>
            <button id="btnShareLink" class="ghost">üîó Copy Participant Link</button>
          </div>
          <div id="copyStatus" class="muted small"></div>
        </div>
      </section>

      <!-- Start Poll -->
      <section class="card">
        <h2>Start Poll</h2>
        
        <!-- Poll selection screen -->
        <div id="pollSelection" style="display: block;">
          <div class="muted small" style="margin-bottom: 8px;">Select a poll type to start polling:</div>
          <div class="row">
            <button id="btnYesNoPoll" class="accent">üìä Yes/No Poll</button>
          </div>
        </div>
        
        <!-- Poll creation screen -->
        <div id="pollCreation" style="display: none;">
          <div class="row">
            <input id="pollQuestion" placeholder="Enter poll question" maxlength="200" style="flex: 1;"/>
          </div>
          <div class="row">
            <button id="btnStartPolling" class="primary">‚ñ∂Ô∏è Start Polling</button>
            <button id="btnCancelPoll" class="ghost">‚úñ Cancel</button>
          </div>
          <div id="pollCreationStatus" class="muted small"></div>
        </div>
        
        <!-- Active poll screen -->
        <div id="pollActive" style="display: none;">
          <div class="muted small">Poll Question:</div>
          <div id="activePollQuestion" class="big" style="font-size: 1.1rem; margin: 8px 0;"></div>
          <div class="muted small">Votes received: <span id="pollVoteCount" style="font-weight: bold;">0</span></div>
          <div class="row" style="margin-top: 12px;">
            <button id="btnEndPoll" class="accent">üìä End Poll and Show Results</button>
          </div>
        </div>
        
        <!-- Poll results screen -->
        <div id="pollResults" style="display: none;">
          <div class="muted small">Last Poll Results:</div>
          <div id="pollResultsQuestion" style="font-weight: bold; margin: 8px 0;"></div>
          <div id="pollResultsData" style="margin: 8px 0;"></div>
          <div class="row" style="margin-top: 12px;">
            <button id="btnContinueDiscussion" class="primary">üí¨ Continue Discussion</button>
            <button id="btnNewPoll" class="accent">üìä Start New Poll</button>
          </div>
        </div>
        
        <!-- No polls message -->
        <div id="pollNone" style="display: none;">
          <div class="muted small">No polls conducted yet</div>
          <div class="row" style="margin-top: 12px;">
            <button id="btnStartFirstPoll" class="accent">üìä Start Poll</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Extract room code from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');

    if (!roomCode || roomCode.length !== 4) {
      alert('Invalid room code. Redirecting to home page.');
      window.location.href = '/landing.html';
    }

    // Display room code
    document.getElementById('roomCodeDisplay').textContent = roomCode;
    document.getElementById('roomCodeLarge').textContent = roomCode;

    // --- Utilities ---
    const $ = sel => document.querySelector(sel);
    const fmt = ms => {
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    };
    const setTimerClass = (el, warn, danger)=>{
      el.classList.remove('ok','warn','danger');
      if (danger) el.classList.add('danger'); else if (warn) el.classList.add('warn'); else el.classList.add('ok');
    };

    // --- DOM refs ---
    const elConn = $('#conn');
    const elQueue = $('#queue'); const elQCount = $('#qCount');
    const elCurName = $('#curName');
    const elSpeakTimer = $('#speakTimer'); const elRemaining = $('#remaining');
    const elMeeting = $('#meetingTimer'); const elLimit = $('#limit');
    
    // Participant controls
    const elParticipantName = $('#participantName');
    const elParticipantStatus = $('#participantStatus');
    
    // Poll controls
    const elPollSelection = $('#pollSelection');
    const elPollCreation = $('#pollCreation');
    const elPollActive = $('#pollActive');
    const elPollResults = $('#pollResults');
    const elPollNone = $('#pollNone');
    const elPollQuestion = $('#pollQuestion');
    const elActivePollQuestion = $('#activePollQuestion');
    const elPollVoteCount = $('#pollVoteCount');
    const elPollResultsQuestion = $('#pollResultsQuestion');
    const elPollResultsData = $('#pollResultsData');
    const elPollCreationStatus = $('#pollCreationStatus');

    // --- State ---
    let client = null;
    let meetingStart = 0;
    let timerInterval = null;
    let currentState = null; // Add this to store the full state

    // --- WebSocket ---
    function connect() {
      const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
      const sock = new WebSocket(`${scheme}://${location.host}/ws`);
      client = Stomp.over(sock);
      client.debug = () => {}; // silence debug

      client.connect({}, () => {
        elConn.textContent = 'Connected';
        elConn.classList.remove('warn');
        elConn.classList.add('ok');

        client.subscribe(`/topic/room/${roomCode}/state`, msg => {
          const state = JSON.parse(msg.body);
          updateUI(state);
        });

        // Join to get initial state
        client.send(`/app/room/${roomCode}/join`, {}, JSON.stringify({name:'Chair'}));
      }, () => {
        elConn.textContent = 'Disconnected';
        elConn.classList.remove('ok');
        elConn.classList.add('warn');
        setTimeout(connect, 2000);
      });
    }

    function updateUI(state) {
      meetingStart = state.meetingStartSec;
      currentState = state; // Store the current state
      elLimit.value = state.defaultLimitSec;

      // Queue
      elQCount.textContent = state.queue.length;
      elQueue.innerHTML = '';
      state.queue.forEach((p, i) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="name">${DOMPurify.sanitize(p.name)}</span>`;
        elQueue.appendChild(li);
      });

      // Current speaker
      if (state.current) {
        const c = state.current;
        elCurName.textContent = DOMPurify.sanitize(c.entry.name);
      } else {
        elCurName.textContent = '--';
      }

      updateTimers(state);
      updatePollUI(state);
    }
    
    function updatePollUI(state) {
      // Hide all poll screens first
      elPollSelection.style.display = 'none';
      elPollCreation.style.display = 'none';
      elPollActive.style.display = 'none';
      elPollResults.style.display = 'none';
      elPollNone.style.display = 'none';
      
      if (!state.pollState) {
        // No poll state - show "no polls conducted yet"
        elPollNone.style.display = 'block';
        return;
      }
      
      const poll = state.pollState;
      
      if (poll.status === 'ACTIVE') {
        // Active poll
        elPollActive.style.display = 'block';
        elActivePollQuestion.textContent = DOMPurify.sanitize(poll.question);
        elPollVoteCount.textContent = poll.totalVotes || 0;
      } else if (poll.status === 'ENDED') {
        // Poll ended - show results
        elPollResults.style.display = 'block';
        elPollResultsQuestion.textContent = DOMPurify.sanitize(poll.question);
        
        // Display results
        let resultsHTML = '<div style="margin-top: 8px;">';
        for (const [option, count] of Object.entries(poll.results)) {
          const percentage = poll.totalVotes > 0 ? Math.round((count / poll.totalVotes) * 100) : 0;
          resultsHTML += `<div style="margin: 4px 0;"><strong>${option}:</strong> ${count} (${percentage}%)</div>`;
        }
        resultsHTML += `<div style="margin-top: 8px;" class="muted small">Total votes: ${poll.totalVotes}</div>`;
        resultsHTML += '</div>';
        elPollResultsData.innerHTML = resultsHTML;
      } else if (poll.lastResults) {
        // No active poll but show last results
        elPollResults.style.display = 'block';
        elPollResultsQuestion.textContent = DOMPurify.sanitize(poll.lastResults.question);
        
        let resultsHTML = '<div style="margin-top: 8px;">';
        for (const [option, count] of Object.entries(poll.lastResults.results)) {
          const percentage = poll.lastResults.totalVotes > 0 ? Math.round((count / poll.lastResults.totalVotes) * 100) : 0;
          resultsHTML += `<div style="margin: 4px 0;"><strong>${option}:</strong> ${count} (${percentage}%)</div>`;
        }
        resultsHTML += `<div style="margin-top: 8px;" class="muted small">Total votes: ${poll.lastResults.totalVotes}</div>`;
        resultsHTML += '</div>';
        elPollResultsData.innerHTML = resultsHTML;
      } else {
        // No polls yet - show message
        elPollNone.style.display = 'block';
      }
    }

    function updateTimers(state) {
      const nowSec = Math.floor(Date.now() / 1000);

      // Meeting timer
      const meetingMs = (nowSec - meetingStart) * 1000;
      elMeeting.textContent = fmt(meetingMs);

      // Speaker timer
      if (state.current) {
        const c = state.current;
        let elapsedMs = c.elapsedMs;
        if (c.running) {
          elapsedMs += (nowSec - c.startedAtSec) * 1000;
        }
        elSpeakTimer.textContent = fmt(elapsedMs);

        const remainingMs = Math.max(0, (c.limitSec * 1000) - elapsedMs);
        elRemaining.textContent = `(remaining: ${fmt(remainingMs)})`;

        const warnThreshold = c.limitSec * 1000 * 0.8;
        const dangerThreshold = c.limitSec * 1000 * 0.95;
        setTimerClass(elSpeakTimer, elapsedMs > warnThreshold, elapsedMs > dangerThreshold);
      } else {
        elSpeakTimer.textContent = '00:00';
        elRemaining.textContent = '(remaining: 00:00)';
        setTimerClass(elSpeakTimer, false, false);
      }
    }

    // --- Event handlers ---
    // Participant controls (on-behalf requests)
    $('#btnParticipantRequest').onclick = () => {
      const name = elParticipantName.value.trim();
      if (!name) {
        elParticipantStatus.textContent = 'Please enter participant name first';
        elParticipantStatus.className = 'warn small';
        return;
      }
      client?.send(`/app/room/${roomCode}/request`, {}, JSON.stringify({name}));
      elParticipantStatus.textContent = `‚úã Request sent for ${name}`;
      elParticipantStatus.className = 'muted small';
    };

    $('#btnParticipantWithdraw').onclick = () => {
      const name = elParticipantName.value.trim();
      if (!name) {
        elParticipantStatus.textContent = 'Please enter participant name first';
        elParticipantStatus.className = 'warn small';
        return;
      }
      client?.send(`/app/room/${roomCode}/withdraw`, {}, JSON.stringify({name}));
      elParticipantStatus.textContent = `Request withdrawn for ${name}`;
      elParticipantStatus.className = 'muted small';
    };

    // Enter key handler for participant name input
    elParticipantName.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const name = elParticipantName.value.trim();
        if (!name) {
          elParticipantStatus.textContent = 'Please enter participant name first';
          elParticipantStatus.className = 'warn small';
          return;
        }
        
        // Check if participant is already in queue, if so withdraw, otherwise request
        const inQueue = currentState && currentState.queue.some(p => p.name.toLowerCase() === name.toLowerCase());
        if (inQueue) {
          $('#btnParticipantWithdraw').click();
        } else {
          $('#btnParticipantRequest').click();
        }
      }
    });

    // Select all text when clicking in the input
    elParticipantName.addEventListener('click', () => {
      elParticipantName.select();
    });

    // Select all text when input gains focus
    elParticipantName.addEventListener('focus', () => {
      elParticipantName.select();
    });

    // Meeting controls
    $('#btnNext').onclick = () => client?.send(`/app/room/${roomCode}/next`, {}, '{}');
    $('#btnPause').onclick = () => client?.send(`/app/room/${roomCode}/timer`, {}, JSON.stringify({action:'pause'}));
    $('#btnStart').onclick = () => client?.send(`/app/room/${roomCode}/timer`, {}, JSON.stringify({action:'start'}));
    $('#btnReset').onclick = () => client?.send(`/app/room/${roomCode}/timer`, {}, JSON.stringify({action:'reset'}));
    $('#btnSetLimit').onclick = () => {
      const sec = parseInt(elLimit.value, 10);
      if (sec >= 10) client?.send(`/app/room/${roomCode}/setLimit`, {}, JSON.stringify({seconds:sec}));
    };

    $('#btnPopout').onclick = () => {
      const url = `/popout.html?room=${roomCode}`;
      window.open(url, 'popout', 'width=325,height=870,resizable=yes');
    };

    // Copy room code
    $('#btnCopyCode').onclick = async () => {
      try {
        await navigator.clipboard.writeText(roomCode);
        $('#copyStatus').textContent = 'Room code copied to clipboard!';
        setTimeout(() => $('#copyStatus').textContent = '', 3000);
      } catch (err) {
        $('#copyStatus').textContent = 'Could not copy to clipboard';
      }
    };

    // Copy participant link
    $('#btnShareLink').onclick = async () => {
      const link = `${window.location.origin}/room/${roomCode}`;
      try {
        await navigator.clipboard.writeText(link);
        $('#copyStatus').textContent = 'Participant link copied to clipboard!';
        setTimeout(() => $('#copyStatus').textContent = '', 3000);
      } catch (err) {
        $('#copyStatus').textContent = 'Could not copy to clipboard';
      }
    };

    // Poll event handlers
    $('#btnYesNoPoll').onclick = () => {
      elPollSelection.style.display = 'none';
      elPollCreation.style.display = 'block';
      elPollQuestion.value = '';
      elPollQuestion.focus();
    };
    
    $('#btnCancelPoll').onclick = () => {
      elPollCreation.style.display = 'none';
      elPollSelection.style.display = 'block';
    };
    
    $('#btnStartPolling').onclick = () => {
      const question = elPollQuestion.value.trim();
      if (!question) {
        elPollCreationStatus.textContent = 'Please enter a question';
        elPollCreationStatus.className = 'warn small';
        return;
      }
      
      client?.send(`/app/room/${roomCode}/poll/start`, {}, JSON.stringify({
        question: question,
        pollType: 'YES_NO'
      }));
      
      elPollCreationStatus.textContent = 'Poll started!';
      elPollCreationStatus.className = 'muted small';
    };
    
    $('#btnEndPoll').onclick = () => {
      client?.send(`/app/room/${roomCode}/poll/end`, {}, '{}');
    };
    
    $('#btnContinueDiscussion').onclick = () => {
      // Just return to the "no polls" view which shows the message
      elPollResults.style.display = 'none';
      elPollNone.style.display = 'block';
    };
    
    $('#btnStartFirstPoll').onclick = () => {
      elPollNone.style.display = 'none';
      elPollSelection.style.display = 'block';
    };
    
    $('#btnNewPoll').onclick = () => {
      elPollResults.style.display = 'none';
      elPollNone.style.display = 'none';
      elPollSelection.style.display = 'block';
    };
    
    // Enter key handler for poll question input
    elPollQuestion.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        $('#btnStartPolling').click();
      }
    });

    // --- Start ---
    connect();
    timerInterval = setInterval(() => {
      if (currentState) {
        updateTimers(currentState);
      }
    }, 250);
  </script>
</body>
</html>
