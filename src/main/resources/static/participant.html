<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SpeakRequest - Participant View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="styles.css"/>
  <script src="stomp.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <h1><a href="/landing.html" style="text-decoration: none; color: inherit;">SpeakRequest</a> - Participant View</h1>
      <div class="room-code-display">
        <span class="muted small">Room Code:</span>
        <span id="roomCodeDisplay" class="room-code">----</span>
      </div>
      <div id="conn" class="pill">Connectingâ€¦</div>
      <div id="chairStatus" class="pill">Chair: Checkingâ€¦</div>
    </header>

    <main class="grid">
      <!-- Participant Controls -->
      <section class="card">
        <h2>Request to Speak</h2>
        <div class="row">
          <input id="name" placeholder="Your initials or name"/>
        </div>
        <div class="row">
          <button id="btnRequest" class="primary">âœ‹ Request to Speak</button>
          <button id="btnWithdraw" class="ghost">Withdraw Request</button>
        </div>
        <div id="status" class="muted small">Enter your initials and click Request to Speak.</div>
      </section>

      <!-- Meeting Status -->
      <section class="card">
        <h2>Meeting Status</h2>

        <div class="two">
          <div>
            <div class="muted small">Current speaker</div>
            <div id="curName" class="big">--</div>
          </div>
          <div>
            <div class="muted small">Speaker time</div>
            <div id="speakTimer" class="timer ok">00:00</div>
            <div class="muted tiny" id="remaining">(remaining: 00:00)</div>
          </div>
          <div>
            <div class="muted small">Meeting time</div>
            <div id="meetingTimer" class="timer">00:00</div>
          </div>
        </div>

        <div class="muted small">Speaking Queue (<span id="qCount">0</span>)</div>
        <ul id="queue" class="list"></ul>
      </section>

      <!-- Room Info -->
      <section class="card">
        <h2>Room Information</h2>
        <div class="room-info">
          <div class="room-code-large">
            <div class="muted small">Room Code:</div>
            <div id="roomCodeLarge" class="room-code-big">----</div>
          </div>
          <div class="row">
            <button id="btnCopyCode" class="ghost">ðŸ“‹ Copy Room Code</button>
          </div>
          <div id="copyStatus" class="muted small"></div>
        </div>
        <div class="row" style="margin-top: 15px;">
          <button id="btnAssumeChair" class="accent" style="display: none;">ðŸ‘¤ Assume Chair Role</button>
        </div>
        <div id="assumeChairStatus" class="muted small"></div>
      </section>
    </main>
  </div>

  <script>
    // Extract room code from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');

    if (!roomCode || roomCode.length !== 4) {
      alert('Invalid room code. Redirecting to home page.');
      window.location.href = '/landing.html';
    }

    // Display room code
    document.getElementById('roomCodeDisplay').textContent = roomCode;
    document.getElementById('roomCodeLarge').textContent = roomCode;

    // --- Utilities ---
    const $ = sel => document.querySelector(sel);
    const fmt = ms => {
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    };
    const setTimerClass = (el, warn, danger)=>{
      el.classList.remove('ok','warn','danger');
      if (danger) el.classList.add('danger'); else if (warn) el.classList.add('warn'); else el.classList.add('ok');
    };

    // --- DOM refs ---
    const elConn = $('#conn');
    const elChairStatus = $('#chairStatus');
    const elStatus = $('#status');
    const elQueue = $('#queue'); const elQCount = $('#qCount');
    const elCurName = $('#curName');
    const elSpeakTimer = $('#speakTimer'); const elRemaining = $('#remaining');
    const elMeeting = $('#meetingTimer');

    const elName = $('#name');
    const elBtnAssumeChair = $('#btnAssumeChair');
    const elAssumeChairStatus = $('#assumeChairStatus');

    // --- State ---
    let client = null;
    let meetingStart = 0;
    let timerInterval = null;
    let myName = '';
    let currentState = null; // Add this to store the full state

    // --- WebSocket ---
    function connect() {
      const sock = new WebSocket(`ws://${location.host}/ws`);
      client = Stomp.over(sock);
      client.debug = () => {}; // silence debug

      client.connect({}, () => {
        elConn.textContent = 'Connected';
        elConn.classList.remove('warn');
        elConn.classList.add('ok');

        client.subscribe(`/topic/room/${roomCode}/state`, msg => {
          const state = JSON.parse(msg.body);
          updateUI(state);
        });

        client.subscribe(`/topic/room/${roomCode}/chairAssumed`, msg => {
          const response = JSON.parse(msg.body);
          if (response.success) {
            elAssumeChairStatus.textContent = 'âœ“ Chair role assumed! Redirecting...';
            elAssumeChairStatus.className = 'ok small';
            // Redirect to chair view
            setTimeout(() => {
              window.location.href = `/chair.html?room=${roomCode}`;
            }, 1000);
          } else {
            elAssumeChairStatus.textContent = 'âœ— ' + (response.error || 'Failed to assume chair role');
            elAssumeChairStatus.className = 'warn small';
            setTimeout(() => {
              elAssumeChairStatus.textContent = '';
            }, 3000);
          }
        });

        // Join to get initial state
        client.send(`/app/room/${roomCode}/join`, {}, JSON.stringify({name:'Anonymous'}));
      }, () => {
        elConn.textContent = 'Disconnected';
        elConn.classList.remove('ok');
        elConn.classList.add('warn');
        setTimeout(connect, 2000);
      });
    }

    function updateUI(state) {
      meetingStart = state.meetingStartSec;
      currentState = state; // Store the current state

      // Update chair status
      if (state.chairOccupied) {
        elChairStatus.textContent = 'Chair: Occupied';
        elChairStatus.classList.remove('ok');
        elChairStatus.classList.add('warn');
        elBtnAssumeChair.style.display = 'none';
      } else {
        elChairStatus.textContent = 'Chair: Vacant';
        elChairStatus.classList.remove('warn');
        elChairStatus.classList.add('ok');
        elBtnAssumeChair.style.display = 'inline-block';
      }

      // Queue
      elQCount.textContent = state.queue.length;
      elQueue.innerHTML = '';
      let myPosition = -1;
      state.queue.forEach((p, i) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="name">${p.name}</span>`;

        // Highlight my entry
        if (p.name.toLowerCase() === myName.toLowerCase()) {
          li.style.backgroundColor = '#e8f4fd';
          li.style.fontWeight = 'bold';
          myPosition = i + 1;
        }

        elQueue.appendChild(li);
      });

      // Update status based on my position
      if (myName) {
        if (state.current && state.current.entry.name.toLowerCase() === myName.toLowerCase()) {
          elStatus.textContent = `ðŸŽ™ï¸ You are currently speaking!`;
          elStatus.className = 'ok small';
        } else if (myPosition > 0) {
          elStatus.textContent = `âœ‹ You are #${myPosition} in the queue`;
          elStatus.className = 'muted small';
        } else {
          elStatus.textContent = `Joined as ${myName}`;
          elStatus.className = 'muted small';
        }
      }

      // Current speaker
      if (state.current) {
        const c = state.current;
        elCurName.textContent = c.entry.name;
      } else {
        elCurName.textContent = '--';
      }

      updateTimers(state);
    }

    function updateTimers(state) {
      const nowSec = Math.floor(Date.now() / 1000);

      // Meeting timer
      const meetingMs = (nowSec - meetingStart) * 1000;
      elMeeting.textContent = fmt(meetingMs);

      // Speaker timer
      if (state.current) {
        const c = state.current;
        let elapsedMs = c.elapsedMs;
        if (c.running) {
          elapsedMs += (nowSec - c.startedAtSec) * 1000;
        }
        elSpeakTimer.textContent = fmt(elapsedMs);

        const remainingMs = Math.max(0, (c.limitSec * 1000) - elapsedMs);
        elRemaining.textContent = `(remaining: ${fmt(remainingMs)})`;

        const warnThreshold = c.limitSec * 1000 * 0.8;
        const dangerThreshold = c.limitSec * 1000 * 0.95;
        setTimerClass(elSpeakTimer, elapsedMs > warnThreshold, elapsedMs > dangerThreshold);
      } else {
        elSpeakTimer.textContent = '00:00';
        elRemaining.textContent = '(remaining: 00:00)';
        setTimerClass(elSpeakTimer, false, false);
      }
    }

    // --- Event handlers ---
    $('#btnRequest').onclick = () => {
      const name = elName.value.trim();
      if (!name) {
        elStatus.textContent = 'Please enter your name first';
        elStatus.className = 'warn small';
        return;
      }
      myName = name;
      client?.send(`/app/room/${roomCode}/request`, {}, JSON.stringify({name}));
    };

    $('#btnWithdraw').onclick = () => {
      const name = elName.value.trim();
      if (!name) {
        elStatus.textContent = 'Please enter your name first';
        elStatus.className = 'warn small';
        return;
      }
      client?.send(`/app/room/${roomCode}/withdraw`, {}, JSON.stringify({name}));
    };

    // Copy room code
    $('#btnCopyCode').onclick = async () => {
      try {
        await navigator.clipboard.writeText(roomCode);
        $('#copyStatus').textContent = 'Room code copied to clipboard!';
        setTimeout(() => $('#copyStatus').textContent = '', 3000);
      } catch (err) {
        $('#copyStatus').textContent = 'Could not copy to clipboard';
      }
    };

    // Assume chair role
    elBtnAssumeChair.onclick = () => {
      if (!client) {
        elAssumeChairStatus.textContent = 'Not connected to server';
        elAssumeChairStatus.className = 'warn small';
        return;
      }
      
      const participantName = myName || 'Participant';
      client.send(`/app/room/${roomCode}/assumeChair`, {}, JSON.stringify({participantName}));
      elAssumeChairStatus.textContent = 'Requesting chair role...';
      elAssumeChairStatus.className = 'muted small';
    };

    // Load name from localStorage
    const savedName = localStorage.getItem('speakRequestName');
    if (savedName) {
      elName.value = savedName;
    }

    // Save name to localStorage when changed
    elName.onchange = () => {
      localStorage.setItem('speakRequestName', elName.value);
    };

    // --- Start ---
    connect();
    timerInterval = setInterval(() => {
      if (currentState) {
        updateTimers(currentState);
      }
    }, 250);
  </script>
</body>
</html>
