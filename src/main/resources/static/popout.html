<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Speaker Display - SPEEK.NOW</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1221; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#60a5fa; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --border: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1000px 600px at 15% -10%, #1e293b 0%, #0b1020 60%, #060914 100%);
      color:var(--text); font:16px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
      padding:20px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border:1px solid var(--border); border-radius:14px; padding:20px; margin-bottom:20px;
    }
    .big{font-weight:800;font-size:2.4rem; margin-bottom:10px;}
    .medium{font-weight:700;font-size:1.6rem; margin-bottom:8px;}
    .small{font-size:1rem; margin-bottom:15px;}
    .muted{color:var(--muted)}
    .timer{font-variant-numeric:tabular-nums;font-weight:800;font-size:2.4rem}
    .timer.ok{color:#bbf7d0}.timer.warn{color:#fde68a}.timer.danger{color:#fecaca}
    .status{color:var(--accent); font-weight:600;}
    .conn-status{position:fixed;top:10px;right:10px;background:#0c1324;border:1px solid var(--border);padding:.35rem .7rem;border-radius:999px;color:var(--muted);font-size:0.8rem;}
    .conn-status.ok{color:#bbf7d0;border-color:rgba(16,185,129,.6)}
    .room-code{position:fixed;top:10px;left:10px;background:#0c1324;border:1px solid var(--border);padding:.35rem .7rem;border-radius:999px;color:var(--accent);font-size:0.8rem;font-weight:bold;}
    .join-instructions{position:fixed;top:40px;left:10px;right:10px;color:var(--muted);font-size:0.75rem;text-align:center;padding-bottom:10px;}
    .content-wrapper{margin-top:60px;}
    .queue-list {
      max-height: 150px;
      overflow-y: auto;
      color: var(--text);
      font-size: 1.2rem;
      margin-top: 10px;
    }
    .qr-float {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ffffff;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .qr-float canvas {
      display: block;
    }
  </style>
  <script src="stomp.min.js"></script>
  <script src="qrcode.min.js"></script>
</head>
<body>
  <div class="room-code" id="roomCodeDisplay">Room: ----</div>
  <div class="conn-status" id="conn">Connectingâ€¦</div>

  <div class="muted small" style="text-align: center; margin-bottom: 15px; margin-top: 35px; color: var(--accent); font-size: 0.8rem;">
    Go to <span id="joinUrl" style="font-weight: bold;"></span> and enter the room code to join
  </div>

  <div class="card">
    <div class="muted small">Current Speaker</div>
    <div id="currentSpeaker" class="big">--</div>
    <div id="currentRole" class="muted medium">--</div>
    <div class="muted small">Speaker Time</div>
    <div id="speakerTimer" class="timer ok">00:00</div>
  </div>

  <div class="card">
    <div class="muted small">Queue (<span id="queueCount">0</span> waiting)</div>
    <div id="queueList" class="queue-list">--</div>
  </div>

  <div id="qrContainer" class="qr-float"></div>

  <script>
    // Get room code from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');

    if (!roomCode || roomCode.length !== 4) {
      document.body.innerHTML = '<div class="card"><div class="big">Invalid room code</div></div>';
    } else {
      document.getElementById('roomCodeDisplay').textContent = `Room: ${roomCode}`;
      // Set join instructions with current browser URL
      const baseUrl = window.location.origin;
      document.getElementById('joinUrl').textContent = `${baseUrl}`;
      
      // Generate QR code for participant join link
      const participantJoinUrl = `${baseUrl}/participant.html?room=${roomCode}`;
      QRCode.toCanvas(participantJoinUrl, {
        width: 150,
        margin: 1,
        color: {
          dark: '#000000',
          light: '#ffffff'
        }
      }, function (error, canvas) {
        if (error) {
          console.error('QR code generation error:', error);
        } else {
          document.getElementById('qrContainer').appendChild(canvas);
        }
      });
    }

    // --- Utilities ---
    const fmt = ms => {
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    };

    const setTimerClass = (el, warn, danger) => {
      el.classList.remove('ok','warn','danger');
      if (danger) el.classList.add('danger');
      else if (warn) el.classList.add('warn');
      else el.classList.add('ok');
    };

    // --- DOM refs ---
    const elConn = document.getElementById('conn');
    const elCurrentSpeaker = document.getElementById('currentSpeaker');
    const elCurrentRole = document.getElementById('currentRole');
    const elSpeakerTimer = document.getElementById('speakerTimer');
    const elQueueCount = document.getElementById('queueCount');
    const elQueueList = document.getElementById('queueList');
    const elJoinInstructions = document.getElementById('joinInstructions');

    // --- State ---
    let client = null;
    let currentState = null;

    // --- WebSocket ---
    function connect() {
      if (!roomCode) return;
      const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
      const sock = new WebSocket(`${scheme}://${location.host}/ws`);
      client = Stomp.over(sock);
      client.debug = () => {}; // silence debug

      client.connect({}, () => {
        elConn.textContent = 'Connected';
        elConn.classList.add('ok');

        client.subscribe(`/topic/room/${roomCode}/state`, msg => {
          const state = JSON.parse(msg.body);
          currentState = state;
          updateDisplay(state);
        });

        // Join to get initial state
        client.send(`/app/room/${roomCode}/join`, {}, JSON.stringify({name:'Display', role:'Observer'}));
      }, () => {
        elConn.textContent = 'Disconnected';
        elConn.classList.remove('ok');
        setTimeout(connect, 2000);
      });
    }

    function updateDisplay(state) {
      // Current speaker
      if (state.current) {
        const c = state.current;
        elCurrentSpeaker.textContent = c.entry.name;
        elCurrentRole.textContent = c.entry.role;
      } else {
        elCurrentSpeaker.textContent = '--';
        elCurrentRole.textContent = '--';
      }

      // Queue - display speakers vertically
      elQueueCount.textContent = state.queue.length;
      if (state.queue.length > 0) {
        const queueHtml = state.queue.map((p, index) =>
          `<div style="margin-bottom: 5px;">${index + 1}. ${p.name}</div>`
        ).join('');
        elQueueList.innerHTML = queueHtml;
      } else {
        elQueueList.innerHTML = '<div>--</div>';
      }

      updateTimer(state);
    }

    function updateTimer(state) {
      if (!state.current) {
        elSpeakerTimer.textContent = '00:00';
        setTimerClass(elSpeakerTimer, false, false);
        return;
      }

      const c = state.current;
      const nowSec = Math.floor(Date.now() / 1000);
      let elapsedMs = c.elapsedMs;

      if (c.running) {
        elapsedMs += (nowSec - c.startedAtSec) * 1000;
      }

      elSpeakerTimer.textContent = fmt(elapsedMs);

      const warnThreshold = c.limitSec * 1000 * 0.8;
      const dangerThreshold = c.limitSec * 1000 * 0.95;
      setTimerClass(elSpeakerTimer, elapsedMs > warnThreshold, elapsedMs > dangerThreshold);
    }

    // --- Start ---
    if (roomCode) {
      connect();

      // Update timer every 250ms
      setInterval(() => {
        if (currentState) {
          updateTimer(currentState);
        }
      }, 250);
    }
  </script>
</body>
</html>